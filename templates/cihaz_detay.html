<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ device.name }} - Cihaz Detaylarƒ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 25px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .back-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .device-header {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .device-title {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .device-id {
            color: #7f8c8d;
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .latest-data-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .data-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .data-card:hover {
            transform: translateY(-5px);
        }

        .data-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: capitalize;
        }

        .data-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .data-unit {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .status-card {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .status-card.inactive {
            background: linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%);
        }

        .timestamp-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            grid-column: 1 / -1;
        }

        .no-data-message {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-size: 1.2em;
        }

        .history-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
        }

        .history-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
        }

        .history-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #ecf0f1;
        }

        .history-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .history-table tr:hover {
            background-color: #e3f2fd;
            transition: background-color 0.3s ease;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .device-title {
                font-size: 2em;
            }

            .data-grid {
                grid-template-columns: 1fr;
            }

            .timestamp-card {
                grid-column: 1;
            }

            .history-table {
                font-size: 0.9em;
            }

            .history-table th,
            .history-table td {
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Geri D√∂n Butonu -->
        <a href="{% url 'home' %}" class="back-btn">
            ‚Üê Ana Sayfaya D√∂n
        </a>

        <!-- Cihaz Ba≈ülƒ±ƒüƒ± -->
        <div class="device-header">
            <h1 class="device-title">{{ device.name }}</h1>
            <div class="device-id">Cihaz ID: {{ device.device_id }}</div>
        </div>

        <!-- Son Veriler -->
        <div class="latest-data-section">
            <h2 class="section-title">Son Veriler</h2>

            {% if veri_gecmisi %}
                {% with son_veri=veri_gecmisi.0 %}
                    {% if son_veri.properties %}
                        <div class="data-grid">
                            {% for key, value in son_veri.properties.items %}
                                <div class="data-card">
                                    <div class="data-label">{{ key|capfirst }}</div>
                                    <div class="data-value">{{ value }}</div>
                                    <div class="data-unit">
                                        {% if key == 'temperature' %}¬∞C
                                        {% elif key == 'pressure' %}hPa
                                        {% elif key == 'humidity' %}%
                                        {% elif key == 'voltage' %}V
                                        {% elif key == 'current' %}A
                                        {% elif key == 'power' %}W
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}

                            <!-- Zaman Kartƒ± -->
                            <div class="data-card timestamp-card">
                                <div class="data-label">Son G√ºncelleme</div>
                                <div class="data-value" style="font-size: 1.2em;">{{ son_veri.updated_at|date:"d M Y - H:i:s" }}</div>
                            </div>
                        </div>
                    {% else %}
                        <div class="no-data-message">
                            Bu cihaz i√ßin veri bulunamadƒ±
                        </div>
                    {% endif %}
                {% endwith %}
            {% else %}
                <div class="no-data-message">
                    Bu cihaz i√ßin hen√ºz veri kaydƒ± bulunmuyor
                </div>
            {% endif %}
        </div>

        <!-- Grafik B√∂l√ºm√º -->
        <div style="background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; margin-bottom: 30px; backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
            <h2 class="section-title">Veri Grafikleri</h2>

            <!-- TEST: Basit grafik -->


            <div id="chartsContainer"></div>
        </div>

        <!-- Veri Ge√ßmi≈üi -->
        <div style="background: rgba(255, 255, 255, 0.9); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
            <h4 style="color: #2c3e50; margin-bottom: 15px;">üìÖ Tarih & Saat Filtresi</h4>

            <form method="GET">
                <div style="display: grid; grid-template-columns: 1fr 1fr auto auto; gap: 15px; align-items: end;">

                    <div>
                        {{ filter_form.start_datetime.label_tag }}
                        {{ filter_form.start_datetime }}
                    </div>

                    <div>
                        {{ filter_form.end_datetime.label_tag }}
                        {{ filter_form.end_datetime }}
                    </div>

                    <button type="submit" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                                 color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; height: fit-content;">
                        üîç Filtrele
                    </button>

                    <a href="?{% if edit_reading %}edit={{ edit_reading.id }}{% endif %}"
                       style="background: #95a5a6; color: white; padding: 10px 20px; text-decoration: none;
                              border-radius: 5px; text-align: center; height: fit-content;">
                        üóëÔ∏è Temizle
                    </a>

                </div>

                <!-- Mevcut edit parametresini koru -->
                {% if edit_reading %}
                    <input type="hidden" name="edit" value="{{ edit_reading.id }}">
                {% endif %}
            </form>

            <!-- Aktif filtre g√∂ster -->
            {% if filter_form.is_bound %}
                <div style="margin-top: 10px; padding: 10px; background: rgba(52, 152, 219, 0.1); border-radius: 5px; color: #2980b9;">
                    <strong>Aktif Filtre:</strong>
                    {% if request.GET.start_datetime %}Ba≈ülangƒ±√ß: {{ request.GET.start_datetime }}{% endif %}
                    {% if request.GET.end_datetime %} | Biti≈ü: {{ request.GET.end_datetime }}{% endif %}
                </div>
            {% endif %}
        </div>

        <div class="history-section">
            <h2 class="section-title">Veri Ge√ßmi≈üi</h2>

            {% if veri_gecmisi %}
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Tarih & Saat</th>
                            {% if veri_gecmisi.0.properties %}
                                {% for key in veri_gecmisi.0.properties.keys %}
                                    <th>{{ key|capfirst }}</th>
                                {% endfor %}
                            {% endif %}
                            <th>ƒ∞≈ülemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for okuma in veri_gecmisi %}
                            <tr>
                                <td><strong>{{ okuma.updated_at|date:"d M Y - H:i:s" }}</strong></td>
                                {% if okuma.properties %}
                                    {% for key, value in okuma.properties.items %}
                                        <td>
                                            {{ value }}
                                            {% if key == 'temperature' %} ¬∞C
                                            {% elif key == 'pressure' %} hPa
                                            {% elif key == 'humidity' %} %
                                            {% elif key == 'voltage' %} V
                                            {% elif key == 'current' %} A
                                            {% elif key == 'power' %} W
                                            {% endif %}
                                        </td>
                                    {% endfor %}
                                {% else %}
                                    <td colspan="{% if veri_gecmisi.0.properties %}{{ veri_gecmisi.0.properties.keys|length }}{% else %}1{% endif %}">
                                        <em>Veri yok</em>
                                    </td>
                                {% endif %}
                                <td>
                                    <a href="?edit={{ okuma.id }}" style="color: #667eea; text-decoration: none; margin-right: 10px;">
                                        ‚úèÔ∏è D√ºzenle
                                    </a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <!-- Django Messages - D√ºzenleme formunun hemen √ºst√ºne eklendi -->
                {% if messages %}
                    <div class="messages-container" style="margin: 20px 0;">
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }}" style="
                                background: rgba(255, 255, 255, 0.95);
                                padding: 15px 20px;
                                margin-bottom: 15px;
                                border-radius: 15px;
                                border-left: 4px solid;
                                position: relative;
                                backdrop-filter: blur(10px);
                                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                                {% if message.tags == 'error' %}
                                    border-left-color: #e74c3c;
                                    background: rgba(231, 76, 60, 0.1);
                                {% elif message.tags == 'success' %}
                                    border-left-color: #27ae60;
                                    background: rgba(39, 174, 96, 0.1);
                                {% elif message.tags == 'warning' %}
                                    border-left-color: #f39c12;
                                    background: rgba(243, 156, 18, 0.1);
                                {% else %}
                                    border-left-color: #3498db;
                                    background: rgba(52, 152, 219, 0.1);
                                {% endif %}
                            ">
                                <strong style="
                                    {% if message.tags == 'error' %}
                                        color: #c0392b;
                                    {% elif message.tags == 'success' %}
                                        color: #229954;
                                    {% elif message.tags == 'warning' %}
                                        color: #d68910;
                                    {% else %}
                                        color: #2980b9;
                                    {% endif %}
                                ">
                                    {% if message.tags == 'error' %}
                                        ‚ùå Hata:
                                    {% elif message.tags == 'success' %}
                                        ‚úÖ Ba≈üarƒ±lƒ±:
                                    {% elif message.tags == 'warning' %}
                                        ‚ö†Ô∏è Uyarƒ±:
                                    {% else %}
                                        ‚ÑπÔ∏è Bilgi:
                                    {% endif %}
                                </strong>
                                <span style="margin-left: 8px; color: #2c3e50;">{{ message }}</span>
                                <button type="button" onclick="this.parentElement.style.display='none'" style="
                                    position: absolute;
                                    top: 12px;
                                    right: 15px;
                                    background: none;
                                    border: none;
                                    font-size: 20px;
                                    cursor: pointer;
                                    opacity: 0.6;
                                    color: #7f8c8d;
                                    transition: opacity 0.3s ease;
                                " title="Kapat" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">√ó</button>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}

                <!-- D√ºzenleme Formu -->
                {% if edit_reading %}
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 10px; margin-top: 20px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">
                            Veri Kaydƒ±nƒ± D√ºzenle - {{ edit_reading.created_at|date:"d M Y - H:i:s" }}
                        </h3>

                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="edit_reading">

                            <!-- Mevcut Properties -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                {% for key, value in edit_reading.properties.items %}
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; color: #666; font-weight: bold;">
                                            {{ key|capfirst }}:
                                        </label>
                                        <input type="text"
                                               name="property_{{ key }}"
                                               value="{{ value }}"
                                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                    </div>
                                {% endfor %}
                            </div>

                            <div style="display: flex; gap: 10px;">
                                <button type="submit"
                                        style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
                                               color: white; padding: 10px 20px; border: none;
                                               border-radius: 5px; cursor: pointer;">
                                    Kaydet
                                </button>

                                <button type="submit" name="action" value="delete_reading"
                                        style="background: linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%);
                                               color: white; padding: 10px 20px; border: none;
                                               border-radius: 5px; cursor: pointer;"
                                        onclick="return confirm('Bu veri kaydƒ±nƒ± silmek istediƒüinizden emin misiniz?')">
                                    Sil
                                </button>

                                <a href="{% url 'device_detail' device_id=device.device_id %}"
                                   style="background: #95a5a6; color: white; padding: 10px 20px;
                                          text-decoration: none; border-radius: 5px; display: inline-block;">
                                    ƒ∞ptal
                                </a>
                            </div>
                        </form>
                    </div>
                {% endif %}

            {% else %}
                <div class="no-data-message">
                    Bu cihaz i√ßin ge√ßmi≈ü veri kaydƒ± bulunmuyor
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Chart.js Script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        const chartDataPerProperty = {{ chart_data_per_property|safe }};
        const chartLabels = {{ chart_labels|safe }};

        console.log('Chart data:', chartDataPerProperty);
        console.log('Chart labels:', chartLabels);

        // Dinamik renk √ºretici
        function generateColor(index) {
            const hue = (index * 137.5) % 360;
            return `hsl(${hue}, 70%, 50%)`;
        }

        function generateBackgroundColor(index) {
            const hue = (index * 137.5) % 360;
            return `hsla(${hue}, 70%, 50%, 0.2)`;
        }

        const chartsContainer = document.getElementById('chartsContainer');
        let colorIndex = 0;

        // Her property i√ßin ayrƒ± grafik olu≈ütur
        for (const [propertyName, propertyData] of Object.entries(chartDataPerProperty)) {
            const chartDiv = document.createElement('div');
            chartDiv.style.marginBottom = '30px';
            chartDiv.innerHTML = `
                <h4 style="color: #2c3e50; margin-bottom: 15px; text-align: center;">
                    ${propertyName.charAt(0).toUpperCase() + propertyName.slice(1)} Grafiƒüi
                    <span style="font-size: 0.8em; color: #7f8c8d;">(Max: ${propertyData.max_value})</span>
                </h4>
                <canvas id="chart_${propertyName}" width="400" height="200"></canvas>
            `;
            chartsContainer.appendChild(chartDiv);

            const ctx2 = document.getElementById(`chart_${propertyName}`).getContext('2d');

            new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: propertyName.charAt(0).toUpperCase() + propertyName.slice(1),
                        data: propertyData.values,
                        borderColor: generateColor(colorIndex),
                        backgroundColor: generateBackgroundColor(colorIndex),
                        tension: 0.1,
                        fill: false,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: propertyData.max_value * 1.1,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    }
                }
            });

            colorIndex++;
        }
    </script>
</body>
</html>